{% extends 'administration/base.html' %}
{% load i18n %}

{% block content %}
<h1>{% blocktranslate with periode=periode %}Satstabel for Afgiftsperiode {{ periode }} {% endblocktranslate %}</h1>
<form method="post">
    {% csrf_token %}
    {{ form.management_form }}
    {% for item in form.forms_by_skematype %}
    {% with skematype=item.skematype subforms=item.forms %}
    <h2>
        {% blocktranslate with id=skematype.id %}Skematype {{id}}{% endblocktranslate %}
    </h2>
    <p>
        {{ skematype }}
    </p>
    <table id="satstabel" class="table">
        <thead>
            <tr>
                <th class="col-3">{% translate 'Fiskeart' %}</th>
                <th class="col-2">{% translate 'Grønlandsk fartøj' %}</th>
                <th class="col-2">{% translate 'Afgiftstype' %}</th>
                <th class="col-2">{% translate 'Afgift, kr pr. kg' %}</th>
                <th class="col-2">{% translate 'Afgift, procent af salgspris' %}</th>
                <th class="col-1"></th>
            </tr>
        </thead>
        <tbody>
        {% for subform in subforms %}
        {% with instance=subform.instance %}
            <tr>
                <td>
                    {{ subform.id }}
                    {{ subform.skematype }}
                    {{ subform.fiskeart }}
                    {{ instance.fiskeart }}
                </td>
                <td>
                    {{ subform.fartoej_groenlandsk }}
                    {{ instance.fartoej_groenlandsk|janej|default_if_none:''|capfirst }}
                </td>
                <td>
                    <select class="type_select form-control">
                        <option value="prkg">{% translate 'Pr. kg.' %}</option>
                        <option value="pct">{% translate 'Procent' %}</option>
                    </select>
                </td>
                <td class="switchcolumn prkg">{{ subform.rate_pr_kg }}</td>
                <td class="switchcolumn pct">{{ subform.rate_procent }}</td>
                <td>
                    {% if subform.id.value %}
                    <a class="btn btn-primary" href="{% url 'administration:satstabelelement-history' subform.id.value %}">
                        {% translate 'Historik' %}
                    </a>
                    {% endif %}
                </td>
            </tr>
            {% if subform.non_field_errors %}
            <tr>
                <td colspan="2"></td>
                <td colspan="3">
                    <div class="invalid-feedback d-block">
                    {{subform.non_field_errors}}
                    </div>
                </td>
            </tr>
            {% endif %}
        {% endwith %}
        {% endfor %}
        </tbody>
    </table>
    {% endwith %}
    {% endfor %}
    <a class="btn btn-secondary" href="{% url 'administration:afgiftsperiode-list' %}">
        {% translate 'Annullér' %}
    </a>
    <button class="btn btn-primary" type="submit">{% translate 'Gem' %}</button>
</form>
<script>
    $('.type_select').change(function (){
        const className = $(this).val();
        const columns = $(this).parents("tr").find(".switchcolumn");
        if (className) {
            columns.filter("." + className).find("input").removeAttr("disabled");
            columns.not("." + className).find("input").attr("disabled", "disabled");
        } else {
            columns.find("input").attr("disabled", "disabled");
        }
    });
    $("#satstabel tbody tr").each(function(){
        const tr = $(this);
        const types = ['prkg', 'pct'];
        const select = tr.find(".type_select");
        let found = false;
        types.forEach(function(type){
            tr.find("."+type+" input").each(function(){
                if (this.value) {
                    select.find("option[value='"+type+"']").prop("selected", true);
                    select.change();
                    found = true;
                    return false;
                }
            });
        });
        if (!found) {
            select.find("option[value='']").prop("selected", true);
            select.change();
        }
    });
</script>
{% endblock %}
